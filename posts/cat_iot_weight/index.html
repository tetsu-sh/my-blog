<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="apple-touch-icon" sizes="128x128" href="/favicon/favicon-128.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32-32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16-16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon-32-32.png"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="A statically generated blog example using Next.js and Markdown."/><meta property="og:image" content="https://og-image.vercel.app/Next.js%20Blog%20Starter%20Example.png?theme=light&amp;md=1&amp;fontSize=100px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><title>猫のIOT体重計作りその１</title><meta name="next-head-count" content="15"/><script src="https://embed.zenn.studio/js/listen-embed-event.js"></script><link rel="preload" href="/_next/static/css/a22c2f7ee8554c55.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a22c2f7ee8554c55.css" data-n-g=""/><link rel="preload" href="/_next/static/css/cf121497002c184d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cf121497002c184d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-491c01545a840e20.js" defer=""></script><script src="/_next/static/chunks/framework-4556c45dd113b893.js" defer=""></script><script src="/_next/static/chunks/main-455fdf1d9b7b48bd.js" defer=""></script><script src="/_next/static/chunks/pages/_app-0f73896300543aa7.js" defer=""></script><script src="/_next/static/chunks/d0447323-452de5d02fa80e1c.js" defer=""></script><script src="/_next/static/chunks/831-17ae48e4ef21c306.js" defer=""></script><script src="/_next/static/chunks/358-bd79b5f955437da8.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-7a79fa351b280d1e.js" defer=""></script><script src="/_next/static/FsgFo1yi2zNDrMDl_8E8Y/_buildManifest.js" defer=""></script><script src="/_next/static/FsgFo1yi2zNDrMDl_8E8Y/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="min-h-screen"><main><div class="flex min-h-screen flex-col"><header><nav class="fixed z-20 w-full bg-gray-700 py-3 text-center font-semibold" aria-label="Header navigation"><span class="test-xs px-2.5 text-neutral-200 hover:text-neutral-500 active:text-gray-600 transition duration-100">home</span><span class="test-xs px-2.5 text-neutral-200 hover:text-neutral-500 active:text-gray-600 transition duration-100">about</span><span class="test-xs px-2.5 text-neutral-200 hover:text-neutral-500 active:text-gray-600 transition duration-100">oisource</span></nav></header><div class="container mx-auto px-5"><article><div></div><div><div class="mt-16"><h1 class="text-5xl md:text-7xl lg:text-3xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">猫のIOT体重計作りその１</h1><div class="mb-6 text-lg"><time dateTime="2023-05-19T12:00:00.000Z">May	19, 2023</time></div><div class="max-w-2xl mx-auto"></div></div></div><div class="flex gap-10 znc"><div class="article"><div class="post"><div class="markdown-styles_markdown__h_8de"><h2 id="%E7%9B%AE%E7%9A%84"><a class="header-anchor-link" href="#%E7%9B%AE%E7%9A%84" aria-hidden="true"></a> 目的</h2>
<ul>
<li>太っている猫と痩せちゃう猫がいるので体重測定を定期的にしたいが、できれば自動化したい。</li>
<li>トイレの量も管理したい。</li>
<li>猫のIOT体重計を作り、それをトイレの下に配置する</li>
</ul>
<h2 id="%E4%BB%95%E7%B5%84%E3%81%BF"><a class="header-anchor-link" href="#%E4%BB%95%E7%B5%84%E3%81%BF" aria-hidden="true"></a> 仕組み</h2>
<ul>
<li>ロードセルを板に貼り付けその板の上にトイレを乗せる。</li>
<li>ロードセルとマイコンをつなぎ、体重変化があったら、データを送信する。</li>
<li>送信先は自宅内PCであり、ローカルネットワーク通信する
<ul>
<li>安上がりなため</li>
</ul>
</li>
<li>PCでローカルのサーバーとDBを立ち上げ、マイコンから送られてきた体重を記録する</li>
</ul>
<h2 id="%E6%80%9D%E3%81%84%E5%87%BA"><a class="header-anchor-link" href="#%E6%80%9D%E3%81%84%E5%87%BA" aria-hidden="true"></a> 思い出</h2>
<ul>
<li>ロードセルは最初は安い体重計を分解して、 combinatorで繋ごうとしたが配線がうまくいかず。ロードセルキットを使用した
<ul>
<li><a href="https://www.switch-science.com/products/8014?variant=42382195687622" target="_blank" rel="nofollow noopener noreferrer">https://www.switch-science.com/products/8014?variant=42382195687622</a></li>
</ul>
</li>
<li>マイコンはATOM LiteというM5stackでWifiモジュール付き
<ul>
<li><a href="https://www.switch-science.com/products/6262?variant=42382099284166" target="_blank" rel="nofollow noopener noreferrer">https://www.switch-science.com/products/6262?variant=42382099284166</a></li>
</ul>
</li>
<li>サーバーはこちら
<ul>
<li><a href="https://github.com/tetsu-sh/weight_server" target="_blank" rel="nofollow noopener noreferrer">https://github.com/tetsu-sh/weight_server</a></li>
<li>ほんとにしょぼいデータをPOSTするだけ。あとそれをGETする</li>
<li>Rust</li>
</ul>
</li>
<li>マイコンファームウェアはarudinoIDEでなんとか,
<ul>
<li>.inoというc言語っぽいやつ<br />
-　cはよくわからないが、サンプルを組み合わせて作った</li>
</ul>
</li>
<li>所定体重以上をマイコンは検出したら、サーバーに送信
<ul>
<li>どれくらいから送信するかが難しい。</li>
</ul>
</li>
<li>体重をゼロにするHTTPAPIも一つ。スマホからPOSTできる</li>
<li>定期的に体重をゼロにしないと尿、便の重さを送信し続けるので、定期的にゼロにする</li>
<li>なんとかデータを送る最低限までした。</li>
<li>意外と精度が良くない</li>
</ul>
<h2 id="%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8"><a class="header-anchor-link" href="#%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8" aria-hidden="true"></a> やりたいこと</h2>
<ul>
<li>データを見る画面
<ul>
<li>データの変化とかも見れたら良いし、どの子が乗ったかをわかるようにしたい</li>
<li>幸い体重だけで個体を識別できる状況</li>
</ul>
</li>
<li>トイレの量を記録したい</li>
</ul>
<p>-　ファームウェア</p>
<div class="code-block-container"><pre class="language-c"><code class="language-c">

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;M5Atom.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;WiFi.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ArduinoJson.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"HX711.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOADCELL_DOUT_PIN</span> <span class="token expression"><span class="token number">32</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOADCELL_SCK_PIN</span>  <span class="token expression"><span class="token number">26</span></span></span>

<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ssid <span class="token operator">=</span> <span class="token string">"hoge"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> password <span class="token operator">=</span> <span class="token string">"hoge"</span><span class="token punctuation">;</span>

HX711 scale<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">float</span> weight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  DynamicJsonDocument <span class="token function">doc</span><span class="token punctuation">(</span><span class="token function">JSON_OBJECT_SIZE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">tm</span> timeInfo<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ntpServer <span class="token operator">=</span> <span class="token string">"ntp.jst.mfeed.ad.jp"</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">long</span> gmtOffset_sec <span class="token operator">=</span> <span class="token number">9</span> <span class="token operator">*</span> <span class="token number">3600</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">int</span> daylightOffset_sec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">configTime</span><span class="token punctuation">(</span>gmtOffset_sec<span class="token punctuation">,</span> daylightOffset_sec<span class="token punctuation">,</span> ntpServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getLocalTime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>timeInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Failed to obtain time"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">char</span> timeStringBuff<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//50 chars should be enough</span>
  <span class="token function">strftime</span><span class="token punctuation">(</span>timeStringBuff<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>timeStringBuff<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%A, %B %d %Y %H:%M:%S"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>timeInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>timeStringBuff<span class="token punctuation">)</span><span class="token punctuation">;</span>
  String <span class="token function">asString</span><span class="token punctuation">(</span>timeStringBuff<span class="token punctuation">)</span><span class="token punctuation">;</span>
  doc<span class="token punctuation">[</span><span class="token string">"timestamp"</span><span class="token punctuation">]</span> <span class="token operator">=</span> timeStringBuff<span class="token punctuation">;</span>
  doc<span class="token punctuation">[</span><span class="token string">"weight"</span><span class="token punctuation">]</span> <span class="token operator">=</span> weight<span class="token punctuation">;</span>
  String json<span class="token punctuation">;</span>
  <span class="token function">serializeJson</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  HTTPClient http<span class="token punctuation">;</span>
  http<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8000/weight"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  http<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  http<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  http<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    M5<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>true<span class="token punctuation">,</span> false<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Calibration sensor...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    M5<span class="token punctuation">.</span>dis<span class="token punctuation">.</span><span class="token function">fillpix</span><span class="token punctuation">(</span><span class="token number">0xff0000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    scale<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>LOADCELL_DOUT_PIN<span class="token punctuation">,</span> LOADCELL_SCK_PIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// The scale value is the adc value corresponding to 1g</span>
    scale<span class="token punctuation">.</span><span class="token function">set_scale</span><span class="token punctuation">(</span><span class="token number">29.71</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// set scale 57500/1935</span>
    scale<span class="token punctuation">.</span><span class="token function">tare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// auto set offset</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>scale<span class="token punctuation">.</span><span class="token function">get_units</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    M5<span class="token punctuation">.</span>dis<span class="token punctuation">.</span><span class="token function">fillpix</span><span class="token punctuation">(</span><span class="token number">0x00ff00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Connect the Weight Unit to PortA(G26,32)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Click Btn A for Tare deduction"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Click Btn B Switch to Calibration mode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    WiFi<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>ssid<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> wifiReconnectCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>WiFi<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> WL_CONNECTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>wifiReconnectCount <span class="token operator">&gt;=</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> ESP<span class="token punctuation">.</span><span class="token function">restart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
      wifiReconnectCount<span class="token operator">++</span><span class="token punctuation">;</span>
      Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>wifiReconnectCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    

    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>scale<span class="token punctuation">.</span><span class="token function">get_units</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> weight <span class="token operator">=</span> scale<span class="token punctuation">.</span><span class="token function">get_units</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000.0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>weight <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Serial<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Weight: %.2fkg \r\n"</span><span class="token punctuation">,</span> weight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">post</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Weight: 0.00kg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    M5<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>M5<span class="token punctuation">.</span>Btn<span class="token punctuation">.</span><span class="token function">wasPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        M5<span class="token punctuation">.</span>dis<span class="token punctuation">.</span><span class="token function">setBrightness</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        M5<span class="token punctuation">.</span>dis<span class="token punctuation">.</span><span class="token function">fillpix</span><span class="token punctuation">(</span><span class="token number">0x0000ff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scale<span class="token punctuation">.</span><span class="token function">tare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        M5<span class="token punctuation">.</span>dis<span class="token punctuation">.</span><span class="token function">fillpix</span><span class="token punctuation">(</span><span class="token number">0x00ff00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    M5<span class="token punctuation">.</span>dis<span class="token punctuation">.</span><span class="token function">setBrightness</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span>weight<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FastLED<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div></div></div></article></div></div><style>
        .aside-toc{
          width:300px;
        }
        .article{
          width:(100-aside-toc.width)%
        }
        </style></main></div><footer><div class="p-10 center bg-neutral-800"><div class="flex flex-col items-center gap-4"><div class="flex gap-4"><span class="text-neutral-200 hover:text-neutral-500 active:text-gray-600 transition duration-100" aria-label="Github" href="https://github.com/tetsu-sh"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></span><span class="text-neutral-200 hover:text-neutral-500 active:text-gray-600 transition duration-100" aria-label="Twitter" href="https://twitter.com/tetsu04228"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"></path></svg></span></div><div class="text-neutral-200 text-sm text-center">© <!-- -->2023<!-- --> Chimu</div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"猫のIOT体重計作りその１","date":"2023-05-19T12:00:00.000Z","slug":"cat_iot_weight","content":"\u003ch2 id=\"%E7%9B%AE%E7%9A%84\"\u003e\u003ca class=\"header-anchor-link\" href=\"#%E7%9B%AE%E7%9A%84\" aria-hidden=\"true\"\u003e\u003c/a\u003e 目的\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e太っている猫と痩せちゃう猫がいるので体重測定を定期的にしたいが、できれば自動化したい。\u003c/li\u003e\n\u003cli\u003eトイレの量も管理したい。\u003c/li\u003e\n\u003cli\u003e猫のIOT体重計を作り、それをトイレの下に配置する\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"%E4%BB%95%E7%B5%84%E3%81%BF\"\u003e\u003ca class=\"header-anchor-link\" href=\"#%E4%BB%95%E7%B5%84%E3%81%BF\" aria-hidden=\"true\"\u003e\u003c/a\u003e 仕組み\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eロードセルを板に貼り付けその板の上にトイレを乗せる。\u003c/li\u003e\n\u003cli\u003eロードセルとマイコンをつなぎ、体重変化があったら、データを送信する。\u003c/li\u003e\n\u003cli\u003e送信先は自宅内PCであり、ローカルネットワーク通信する\n\u003cul\u003e\n\u003cli\u003e安上がりなため\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ePCでローカルのサーバーとDBを立ち上げ、マイコンから送られてきた体重を記録する\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"%E6%80%9D%E3%81%84%E5%87%BA\"\u003e\u003ca class=\"header-anchor-link\" href=\"#%E6%80%9D%E3%81%84%E5%87%BA\" aria-hidden=\"true\"\u003e\u003c/a\u003e 思い出\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eロードセルは最初は安い体重計を分解して、 combinatorで繋ごうとしたが配線がうまくいかず。ロードセルキットを使用した\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.switch-science.com/products/8014?variant=42382195687622\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ehttps://www.switch-science.com/products/8014?variant=42382195687622\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eマイコンはATOM LiteというM5stackでWifiモジュール付き\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.switch-science.com/products/6262?variant=42382099284166\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ehttps://www.switch-science.com/products/6262?variant=42382099284166\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eサーバーはこちら\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/tetsu-sh/weight_server\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003ehttps://github.com/tetsu-sh/weight_server\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eほんとにしょぼいデータをPOSTするだけ。あとそれをGETする\u003c/li\u003e\n\u003cli\u003eRust\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eマイコンファームウェアはarudinoIDEでなんとか,\n\u003cul\u003e\n\u003cli\u003e.inoというc言語っぽいやつ\u003cbr /\u003e\n-　cはよくわからないが、サンプルを組み合わせて作った\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e所定体重以上をマイコンは検出したら、サーバーに送信\n\u003cul\u003e\n\u003cli\u003eどれくらいから送信するかが難しい。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e体重をゼロにするHTTPAPIも一つ。スマホからPOSTできる\u003c/li\u003e\n\u003cli\u003e定期的に体重をゼロにしないと尿、便の重さを送信し続けるので、定期的にゼロにする\u003c/li\u003e\n\u003cli\u003eなんとかデータを送る最低限までした。\u003c/li\u003e\n\u003cli\u003e意外と精度が良くない\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8\"\u003e\u003ca class=\"header-anchor-link\" href=\"#%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8\" aria-hidden=\"true\"\u003e\u003c/a\u003e やりたいこと\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eデータを見る画面\n\u003cul\u003e\n\u003cli\u003eデータの変化とかも見れたら良いし、どの子が乗ったかをわかるようにしたい\u003c/li\u003e\n\u003cli\u003e幸い体重だけで個体を識別できる状況\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eトイレの量を記録したい\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e-　ファームウェア\u003c/p\u003e\n\u003cdiv class=\"code-block-container\"\u003e\u003cpre class=\"language-c\"\u003e\u003ccode class=\"language-c\"\u003e\n\n\u003cspan class=\"token macro property\"\u003e\u003cspan class=\"token directive-hash\"\u003e#\u003c/span\u003e\u003cspan class=\"token directive keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026lt;M5Atom.h\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token macro property\"\u003e\u003cspan class=\"token directive-hash\"\u003e#\u003c/span\u003e\u003cspan class=\"token directive keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026lt;WiFi.h\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token macro property\"\u003e\u003cspan class=\"token directive-hash\"\u003e#\u003c/span\u003e\u003cspan class=\"token directive keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026lt;ArduinoJson.h\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token macro property\"\u003e\u003cspan class=\"token directive-hash\"\u003e#\u003c/span\u003e\u003cspan class=\"token directive keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"HX711.h\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token macro property\"\u003e\u003cspan class=\"token directive-hash\"\u003e#\u003c/span\u003e\u003cspan class=\"token directive keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026lt;stdio.h\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token macro property\"\u003e\u003cspan class=\"token directive-hash\"\u003e#\u003c/span\u003e\u003cspan class=\"token directive keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026lt;time.h\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\n\u003cspan class=\"token macro property\"\u003e\u003cspan class=\"token directive-hash\"\u003e#\u003c/span\u003e\u003cspan class=\"token directive keyword\"\u003edefine\u003c/span\u003e \u003cspan class=\"token macro-name\"\u003eLOADCELL_DOUT_PIN\u003c/span\u003e \u003cspan class=\"token expression\"\u003e\u003cspan class=\"token number\"\u003e32\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token macro property\"\u003e\u003cspan class=\"token directive-hash\"\u003e#\u003c/span\u003e\u003cspan class=\"token directive keyword\"\u003edefine\u003c/span\u003e \u003cspan class=\"token macro-name\"\u003eLOADCELL_SCK_PIN\u003c/span\u003e  \u003cspan class=\"token expression\"\u003e\u003cspan class=\"token number\"\u003e26\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e ssid \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hoge\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e password \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"hoge\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\nHX711 scale\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003epost\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efloat\u003c/span\u003e weight\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  DynamicJsonDocument \u003cspan class=\"token function\"\u003edoc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eJSON_OBJECT_SIZE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token class-name\"\u003etm\u003c/span\u003e timeInfo\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e ntpServer \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"ntp.jst.mfeed.ad.jp\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token keyword\"\u003elong\u003c/span\u003e gmtOffset_sec \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e9\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e3600\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e daylightOffset_sec \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\t\u003cspan class=\"token function\"\u003econfigTime\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003egmtOffset_sec\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e daylightOffset_sec\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e ntpServer\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token function\"\u003egetLocalTime\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026amp;\u003c/span\u003etimeInfo\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Failed to obtain time\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e timeStringBuff\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e50\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e//50 chars should be enough\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003estrftime\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etimeStringBuff\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003esizeof\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etimeStringBuff\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"%A, %B %d %Y %H:%M:%S\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u003c/span\u003etimeInfo\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etimeStringBuff\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  String \u003cspan class=\"token function\"\u003easString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etimeStringBuff\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  doc\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"timestamp\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e timeStringBuff\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  doc\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"weight\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e weight\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  String json\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003eserializeJson\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edoc\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e json\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ejson\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  HTTPClient http\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ebegin\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"http://localhost:8000/weight\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Content-Type\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"application/json\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ePOST\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebody\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003esetup\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    M5\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ebegin\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etrue\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e false\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e true\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Calibration sensor....\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    M5\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edis\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efillpix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0xff0000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    scale\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ebegin\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eLOADCELL_DOUT_PIN\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e LOADCELL_SCK_PIN\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// The scale value is the adc value corresponding to 1g\u003c/span\u003e\n    scale\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eset_scale\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e29.71\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e  \u003cspan class=\"token comment\"\u003e// set scale 57500/1935\u003c/span\u003e\n    scale\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etare\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e             \u003cspan class=\"token comment\"\u003e// auto set offset\u003c/span\u003e\n    Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003escale\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget_units\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    M5\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edis\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efillpix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0x00ff00\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Connect the Weight Unit to PortA(G26,32)\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Click Btn A for Tare deduction\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Click Btn B Switch to Calibration mode\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    WiFi\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ebegin\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003essid\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e password\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e wifiReconnectCount \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eWiFi\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003estatus\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e WL_CONNECTED\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewifiReconnectCount \u003cspan class=\"token operator\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"token number\"\u003e300\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e ESP\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erestart\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n      wifiReconnectCount\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewifiReconnectCount\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003edelay\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003eloop\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \n\n    Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003escale\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget_units\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efloat\u003c/span\u003e weight \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e scale\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eget_units\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e/\u003c/span\u003e\u003cspan class=\"token number\"\u003e1000.0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eweight \u003cspan class=\"token operator\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Weight: %.2fkg \\r\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e weight\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003epost\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eweight\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"POST\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        Serial\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eprintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Weight: 0.00kg\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    M5\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eupdate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eM5\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eBtn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ewasPressed\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        M5\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edis\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetBrightness\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        M5\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edis\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efillpix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0x0000ff\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        scale\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etare\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003edelay\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e500\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        M5\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edis\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efillpix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0x00ff00\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    M5\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edis\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetBrightness\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eweight\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    FastLED\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eshow\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"cat_iot_weight"},"buildId":"FsgFo1yi2zNDrMDl_8E8Y","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>